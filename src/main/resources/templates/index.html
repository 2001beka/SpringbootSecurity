<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Add user</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
          integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
</head>
<body>

<div class=""></div>
<!--//form table-->
<div class="container">
    <div>
        <button class="btn btn-outline-success" data-toggle="modal" data-target="#saveUser">Add user</button>
        <button class="btn btn-outline-danger"><a href="/user">User_table</a></button>
        <button class="btn btn-outline-danger" style="left: initial"><a href="/logout">log out</a></button>
    </div>
    <table id="users_table" class="table table-bordered table-hover table-condensed "
           style="background-color:lightblue"></table>
</div>

<!--       form Save-->
<div class="modal" id="saveUser" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveUserLabel">Save User</h5>
                <button class="btn btn-danger" data-dismiss="modal" aria-label="close">x</button>
            </div>
            <div class="modal-body">
                <form id="register" method="post" class="form-horizontal">
                    <div class="text-center">
                        <div class="container" style="background: yellowgreen">
                            <h2>Add new user</h2>
                            <div>
                                <div class="from-group">
                                    <label for="name" class="control-label col md-2">Name</label>
                                    <div class="col md-6">
                                        <input type="text" field="*{name}" id="name" placeholder="Name" required>
                                    </div>
                                </div>
                                <div class="from-group">
                                    <label for="national" class="control-label col md-2">National</label>
                                    <div class="col md-6">
                                        <input type="text" field="*{national}" id="national" placeholder="National"
                                               required>
                                    </div>
                                </div>
                                <div class="from-group">
                                    <label for="password" class="control-label col md-2">Password</label>
                                    <div class="col md-6">
                                        <input type="text" field="*{password}" id="password" placeholder="Password"
                                               required>
                                    </div>
                                </div>
                                <div class="from-group">
                                    <label for="age" class="control-label col md-2">Age</label>
                                    <div class="col md-6">
                                        <input type="text" field="*{age}" id="age" placeholder="age" required>
                                    </div>
                                </div>
                                <div class="from-group">
                                    <label for="salary" class="control-label col md-2">Salary</label>
                                    <div class="col md-6">
                                        <input type="text" field="*{salary}" id="salary" placeholder="salary" required>
                                    </div>
                                </div>
                                <div class="from-group">
                                    <label for="role" class="control-label col md-2"><b>Role</b></label>
                                    <div class="col md-6">
                                        <select name="role" id="role">
                                            <option id="roleUser" value="ROLE_USER" selected>User</option>
                                            <!--                                            <option id="roleAdmin" value="ROLE_ADMIN">Admin</option>-->
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <br>
                            <input type="submit" class="btn btn-success" value="Add user">
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<!--//form update-->
<div class="modal" id="updateUser" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateUserLabel">Form</h5>
                <button class="btn btn-danger" data-dismiss="modal" aria-label="close">x</button>
            </div>
            <div class="modal-body">
                <form id="edit_user" class="form-horizontal">
                    <div class="from-group">
                        <label for="idE" class="control-label col md-2">ID</label>
                        <div class="col md-6">
                            <input type="text" field="*{id}" id="idE" placeholder="ID">
                        </div>
                    </div>
                    <br>
                    <div class="from-group">
                        <label for="nameE" class="control-label col md-2">Name</label>
                        <div class="col md-6">
                            <input type="text" field="*{name}" id="nameE" placeholder="Name">
                        </div>
                    </div>
                    <br>
                    <div class="from-group">
                        <label for="nationalE" class="control-label col md-2">National</label>
                        <div class="col md-6">
                            <input type="text" field="*{national}" id="nationalE" placeholder="National">
                        </div>
                    </div>
                    <br>
                    <div class="from-group">
                        <label for="passwordE" class="control-label col md-2">Password</label>
                        <div class="col md-6">
                            <input type="text" field="*{password}" id="passwordE" placeholder="Password">
                        </div>
                    </div>
                    <br>
                    <div class="from-group">
                        <label for="ageE" class="control-label col md-2">Age</label>
                        <div class="col md-6">
                            <input type="text" field="*{age}" id="ageE" placeholder="Age">
                        </div>
                    </div>
                    <br>
                    <div class="from-group">
                        <label for="salaryE" class="control-label col md-2">Salary</label>
                        <div class="col md-6">
                            <input type="text" field="*{salary}" id="salaryE"
                                   placeholder="Salary">
                        </div>
                    </div>
                    <br>
                    <input type="submit" class="btn btn-success" value="Update user">
                </form>
            </div>
        </div>
    </div>
</div>


<script>

    // getAllUser from DB
    async function getAllUsers() {
        const url = "http://localhost:8858/api/list"
        let response = await fetch(url)
            .then(response => response.json())
            .then(lists => {
                let list = `
        <tr class="ui-state-active" style="background-color:grey">
               <th>Id</th>
               <th>Name</th>
               <th>National</th>
               <th>Password</th>
               <th>Age</th>
               <th>Salary</th>
               <th>Edit</th>
               <th>Delete</th>
           </tr>`;
                lists.forEach(userId => {
                    let userRole = '';
                    for (let i = 0; i < userId.roles.length; i++) {
                        userRole += `${userId.roles[i].role}`
                    }
                    list += `
               <tr>
               <td>${userId.id}</td>
               <td id="nameValue${userId.id}">${userId.name}</td>
               <td id="nationalValue${userId.id}">${userId.national}</td>
               <td id="passwordValue${userId.id}">${userId.password}</td>
               <td id="ageValue${userId.id}">${userId.age}</td>
               <td id="salaryValue${userId.id}">${userId.salary}</td>
               <td><button onclick="getUserdata(${userId.id})" class="btn btn-outline-success" data-toggle="modal" data-target="#updateUser">edit</button></td>
              <td data-id="${userId.id}"><a href="#" class="card-link" id="delete_user" >Delete</a></td></tr>`
                });
                document.getElementById("users_table").innerHTML = list;
            })
    }

    getAllUsers()


    //   saveUser
    const register = document.getElementById('register');
    let urlAdd = 'http://localhost:8858/api/register'
    register.addEventListener('submit', async function (event) {
        event.preventDefault();

        let name = document.getElementById('name').value;
        let national = document.getElementById('national').value;
        let password = document.getElementById('password').value;
        let age = document.getElementById('age').value;
        let salary = document.getElementById('salary').value;

        // let role = document.getElementById('role');
        // let value = role.options[role.selectedIndex].value;
        let response = await fetch(urlAdd, {
            method: "POST",
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                national: national,
                password: password,
                age: age,
                salary: salary,
                // roles: [
                //     {
                //        role : value
                //     }
                // ]
            })
        })
        // .then(response => response.json())
        // .then(data => {
        //     const dataArr = [];
        //     dataArr.push(data);
        //     renderPost(dataArr);
        // })
        // .then(() => location.reload());

        // });
        let answer = await response.json();
        console.log(answer);


        setTimeout(test, 100);

        function test() {
            document.location.href = "/" //'http://localhost:8899/api/list'
        }
    })

    //   Delete
    const table = document.querySelector('table');
    const url = 'http://localhost:8858/api'
    table.addEventListener('click', (event) => {
        event.preventDefault()
        let deleteButton = event.target.id === 'delete_user';
        let Id = event.target.parentElement.dataset.id;
        if (deleteButton) {
            fetch(`${url}/${Id}`, {
                method: 'DELETE',
            })
                .then(response => response.text())
                .then(() => location.reload())
            alert("Are you sure delete user");
        }
    })


    // updateUser
    const up = document.getElementById('edit_user');
    let urlE = 'http://localhost:8858/api'
    up.addEventListener('submit', async function (event) {
        event.preventDefault();

        console.log('hello')
        let id = document.getElementById('idE').value;
        let name = document.getElementById('nameE').value;
        let national = document.getElementById('nationalE').value;
        let password = document.getElementById('passwordE').value;
        let age = document.getElementById('ageE').value;
        let salary = document.getElementById('salaryE').value;

        let response = await fetch(urlE, {
            method: "PUT",
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                id: id,
                name: name,
                national: national,
                password: password,
                age: age,
                salary: salary
            })
        });
        let answer = await response.json();
        console.log(answer);
        setTimeout(test, 100);

        function test() {
            document.location.href = "/"
        }
    })


    function getUserdata(userId) {
        document.getElementById('idE').value = userId;
        document.getElementById('nameE').value = $("#nameValue" + userId).text();
        document.getElementById('nationalE').value = $("#nationalValue" + userId).text();
        document.getElementById('passwordE').value = $("#passwordValue" + userId).text();
        document.getElementById('ageE').value = $("#ageValue" + userId).text()
        document.getElementById('salaryE').value = $("#salaryValue" + userId).text()
    }
</script>


<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
</body>
</html>